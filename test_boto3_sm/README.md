## demo

using `gunicorn[gevent]` to run `flask` app
when at the route func query `secret-manager` will trigger ```RecursionError: maximum recursion depth exceeded```

## up
``` docker-compose up --build```


## errors

```
Failed to get k8s token: [Errno 2] No such file or directory: '/var/run/secrets/kubernetes.io/serviceaccount/token'
AwsEksResourceDetector failed: [Errno 2] No such file or directory: '/var/run/secrets/kubernetes.io/serviceaccount/token'
AwsEcsResourceDetector failed: Missing ECS_CONTAINER_METADATA_URI therefore process is not on ECS.
Exception  in detector <opentelemetry.sdk.extension.aws.resource.ec2.AwsEc2ResourceDetector object at 0x7fb80e8cca90>, ignoring
AwsEc2ResourceDetector failed: timed out
Configuration of configurator not loaded, aws_configurator already loaded
{"name": "gunicorn.error", "otelSpanID": "0", "otelTraceID": "0", "otelTraceSampled": false, "otelServiceName": "devopsdemo", "logtime": "2024-05-06T06:04:36.017334+00:00", "level": "INFO", "function": "info", "content": "Starting gunicorn 22.0.0"}
{"name": "gunicorn.error", "otelSpanID": "0", "otelTraceID": "0", "otelTraceSampled": false, "otelServiceName": "devopsdemo", "logtime": "2024-05-06T06:04:36.030004+00:00", "level": "INFO", "function": "info", "content": "Listening at: http://0.0.0.0:8000 (1)"}
{"name": "gunicorn.error", "otelSpanID": "0", "otelTraceID": "0", "otelTraceSampled": false, "otelServiceName": "devopsdemo", "logtime": "2024-05-06T06:04:36.030164+00:00", "level": "INFO", "function": "info", "content": "Using worker: gevent"}
{"name": "gunicorn.error", "otelSpanID": "0", "otelTraceID": "0", "otelTraceSampled": false, "otelServiceName": "devopsdemo", "logtime": "2024-05-06T06:04:36.034261+00:00", "level": "INFO", "function": "info", "content": "Booting worker with pid: 13"}
/usr/local/lib/python3.11/site-packages/gunicorn/workers/ggevent.py:39: MonkeyPatchWarning: Monkey-patching ssl after ssl has already been imported may lead to errors, including RecursionError on Python 3.6. It may also silently lead to incorrect behaviour on Python 3.7. Please monkey-patch earlier. See https://github.com/gevent/gevent/issues/1016. Modules that had direct imports (NOT patched): ['botocore.httpsession (/usr/local/lib/python3.11/site-packages/botocore/httpsession.py)', 'urllib3.util (/otel-auto-instrumentation-python/urllib3/util/__init__.py)', 'urllib3.util.ssl_ (/otel-auto-instrumentation-python/urllib3/util/ssl_.py)'].
  monkey.patch_all()
{"name": "gunicorn.error", "exc_info": "Traceback (most recent call last):\n  File \"/usr/local/lib/python3.11/site-packages/gunicorn/arbiter.py\", line 609, in spawn_worker\n    worker.init_process()\n  File \"/usr/local/lib/python3.11/site-packages/gunicorn/workers/ggevent.py\", line 147, in init_process\n    super().init_process()\n  File \"/usr/local/lib/python3.11/site-packages/gunicorn/workers/base.py\", line 134, in init_process\n    self.load_wsgi()\n  File \"/usr/local/lib/python3.11/site-packages/gunicorn/workers/base.py\", line 146, in load_wsgi\n    self.wsgi = self.app.wsgi()\n                ^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/gunicorn/app/base.py\", line 67, in wsgi\n    self.callable = self.load()\n                    ^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/gunicorn/app/wsgiapp.py\", line 58, in load\n    return self.load_wsgiapp()\n           ^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/gunicorn/app/wsgiapp.py\", line 48, in load_wsgiapp\n    return util.import_app(self.app_uri)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/gunicorn/util.py\", line 424, in import_app\n    app = app(*args, **kwargs)\n          ^^^^^^^^^^^^^^^^^^^^\n  File \"/app/app.py\", line 20, in create_app\n    sm = boto3.client(\"secretsmanager\").get_secret_value(\n         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/otel-auto-instrumentation-python/opentelemetry/instrumentation/boto3sqs/__init__.py\", line 381, in client_wrapper\n    retval = wrapped(*args, **kwargs)\n             ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/boto3/__init__.py\", line 92, in client\n    return _get_default_session().client(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/boto3/session.py\", line 299, in client\n    return self._session.create_client(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/botocore/session.py\", line 957, in create_client\n    credentials = self.get_credentials()\n                  ^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/botocore/session.py\", line 513, in get_credentials\n    self._credentials = self._components.get_component(\n                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/botocore/session.py\", line 1140, in get_component\n    self._components[name] = factory()\n                             ^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/botocore/session.py\", line 192, in _create_credential_resolver\n    return botocore.credentials.create_credential_resolver(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/botocore/credentials.py\", line 95, in create_credential_resolver\n    container_provider = ContainerProvider()\n                         ^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/botocore/credentials.py\", line 1918, in __init__\n    fetcher = ContainerMetadataFetcher()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/botocore/utils.py\", line 3049, in __init__\n    session = botocore.httpsession.URLLib3Session(\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/botocore/httpsession.py\", line 323, in __init__\n    self._manager = PoolManager(**self._get_pool_manager_kwargs())\n                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/botocore/httpsession.py\", line 340, in _get_pool_manager_kwargs\n    'ssl_context': self._get_ssl_context(),\n                   ^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/botocore/httpsession.py\", line 349, in _get_ssl_context\n    return create_urllib3_context()\n           ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/site-packages/botocore/httpsession.py\", line 139, in create_urllib3_context\n    context.options |= options\n    ^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.11/ssl.py\", line 624, in options\n    super(SSLContext, SSLContext).options.__set__(self, value)\n  File \"/usr/local/lib/python3.11/ssl.py\", line 624, in options\n    super(SSLContext, SSLContext).options.__set__(self, value)\n  File \"/usr/local/lib/python3.11/ssl.py\", line 624, in options\n    super(SSLContext, SSLContext).options.__set__(self, value)\n  [Previous line repeated 480 more times]\nRecursionError: maximum recursion depth exceeded", "otelSpanID": "0", "otelTraceID": "0", "otelTraceSampled": false, "otelServiceName": "devopsdemo", "logtime": "2024-05-06T06:04:36.413263+00:00", "level": "ERROR", "function": "exception", "content": "Exception in worker process"}
{"name": "gunicorn.error", "otelSpanID": "0", "otelTraceID": "0", "otelTraceSampled": false, "otelServiceName": "devopsdemo", "logtime": "2024-05-06T06:04:36.433595+00:00", "level": "INFO", "function": "info", "content": "Worker exiting (pid: 13)"}
Exception ignored in thread started by: <bound method Thread._bootstrap of <Thread(OtelBatchSpanProcessor, started daemon 140428482381568)>>
Traceback (most recent call last):
  File "/usr/local/lib/python3.11/threading.py", line 995, in _bootstrap
    self._bootstrap_inner()
  File "/usr/local/lib/python3.11/threading.py", line 1042, in _bootstrap_inner
    self._delete()
  File "/usr/local/lib/python3.11/threading.py", line 1074, in _delete
    del _active[get_ident()]
        ~~~~~~~^^^^^^^^^^^^^
KeyError: 140428483168768
{"name": "gunicorn.error", "otelSpanID": "0", "otelTraceID": "0", "otelTraceSampled": false, "otelServiceName": "devopsdemo", "logtime": "2024-05-06T06:04:36.668462+00:00", "level": "ERROR", "function": "error", "content": "Worker (pid:13) exited with code 3"}
{"name": "gunicorn.error", "otelSpanID": "0", "otelTraceID": "0", "otelTraceSampled": false, "otelServiceName": "devopsdemo", "logtime": "2024-05-06T06:04:36.669351+00:00", "level": "ERROR", "function": "error", "content": "Shutting down: Master"}
{"name": "gunicorn.error", "otelSpanID": "0", "otelTraceID": "0", "otelTraceSampled": false, "otelServiceName": "devopsdemo", "logtime": "2024-05-06T06:04:36.669602+00:00", "level": "ERROR", "function": "error", "content": "Reason: Worker failed to boot."}
```
